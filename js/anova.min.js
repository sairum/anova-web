"use strict";var anova=(function(){const RANDOM=0;const FIXED=1;var data=[];var nfactors=0;var factors=[];var partials=[];var terms=[];var mcomps=[];var replicates=0;var corrected_df=0;var total={df:0,ss:0};var residual={name:'Error',df:0,ss:0};var nesting=false;var ignoreinteractions=false;var max_value=Number.MIN_SAFE_INTEGER;var min_value=Number.MAX_SAFE_INTEGER;const DEFAULT_REJECTION_LEVEL=0.05;var rejection_level=DEFAULT_REJECTION_LEVEL;var mt_rejection_level=DEFAULT_REJECTION_LEVEL;var filename='';function buildMultipleComparisons(){}
function buildTerms(){let s=Math.pow(2,nfactors);for(let i=1;i<s;i++){let temp={idx:0,name:"",codes:[],order:0,combins:1,nlevels:0,levels:[],sumx:[],sumx2:[],n:[],average:[],ss:0,df:1,SS:0,ct_codes:[],varcomp:[],MS:0,P:0,against:-1,F:0,type:FIXED};for(let j=0;j<nfactors;j++){temp.idx=i;if((i&Math.pow(2,j))){temp.codes[j]=1;temp.order++;temp.combins*=factors[j].nlevels;temp.type*=factors[j].type;}else{temp.codes[j]=0;}
temp.codes.push(0);}
terms.push(temp);}
if(getPartialSS()){terms.sort(function(a,b){return(a.order-b.order)||(a.idx-b.idx)});for(let i=0,len=terms.length-2;i<len;i++){if(terms[i].order==1){terms[i].df=factors[i].nlevels-1;}else{let m=1;for(let j=0;j<nfactors;j++){if(terms[i].codes[j]>0)m*=factors[j].nlevels-1;}
terms[i].df=m;}
terms[i].MS=terms[i].SS/terms[i].df;}
let e=terms.length-2;terms[e].MS=terms[e].SS/terms[e].df;correctForNesting();computeCTRules();displayAverages();buildMultipleComparisons();displayMultipleComparisons();displayANOVA();}}
function computeCTRules(){for(let i=0,tl=terms.length-2;i<tl;i++){terms[i].ct_codes=new Array(nfactors+1).fill(0);for(let k=0;k<nfactors;k++){let t=terms[i].codes[k];if(t!=0){if(t==1){if(factors[k].type===RANDOM)terms[i].ct_codes[k]=1;else terms[i].ct_codes[k]=0;}else{terms[i].ct_codes[k]=1;}}else{terms[i].ct_codes[k]=factors[k].nlevels;}}
terms[i].ct_codes[nfactors]=replicates;}
let tl=terms.length-1;for(let i=0;i<tl;i++){for(let j=0;j<tl;j++){let included=true;for(let k=0;k<nfactors+1;k++){if((terms[i].codes[k]>0)&&(terms[j].codes[k]==0)){included=false;break;}}
if(included)terms[i].varcomp.push(1);else terms[i].varcomp.push(0);}}
for(let i=0;i<tl;i++){for(let j=0;j<tl;j++){if(terms[i].varcomp[j]==1){let product=1;for(let k=0;k<nfactors+1;k++){if(terms[i].codes[k]==0){product*=terms[j].ct_codes[k];}}
terms[i].varcomp[j]=product;}}}
tl=terms.length;for(let i=0;i<tl-2;i++){let pf;for(let j=tl-2;j>=0;j--){let found=true;if(i!=j){for(let k=0,vl=terms[i].varcomp.length;k<vl;k++){if(k!=i){if(terms[i].varcomp[k]!=terms[j].varcomp[k]){found=false
break;}}}}else{found=false;}
if(found){terms[i].against=j;terms[i].F=terms[i].MS/terms[j].MS;pf=jStat.centralF.cdf(terms[i].F,terms[i].df,terms[j].df);terms[i].P=1-pf;break;}else{terms[i].against=-1;terms[i].F=NaN;terms[i].P=NaN;}}}
displayCTRules();}
function computePartials(){let partials_hash=[];let maxn=0;for(let i=0,ds=data.length;i<ds;i++){let codes=[];for(let j=0,len=data[i].levels.length;j<len;j++){let l=data[i].levels[j];let k=factors[j].levels.indexOf(l);codes[j]=k;}
let p={};p.codes=codes;p.sumx=data[i].value;p.sumx2=Math.pow(data[i].value,2);p.n=1;p.n_orig=1;if(partials.length==0){partials_hash[codes]=partials.push(p)-1;}else{let v=partials_hash.hasOwnProperty(codes)?partials_hash[codes]:-1;if(v!=-1){partials[v].sumx+=p.sumx;partials[v].sumx2+=p.sumx2;partials[v].n++;if(partials[v].n>maxn)maxn=partials[v].n;}else{partials_hash[codes]=partials.push(p)-1;}}}
for(let i=0,tl=partials.length;i<tl;i++){partials[i].n_orig=partials[i].n;if(partials[i].n<maxn){let average=partials[i].sumx/partials[i].n;let n=maxn-partials[i].n;for(let j=0;j<n;j++){corrected_df++;partials[i].sumx+=average;partials[i].sumx2+=Math.pow(average,2);partials[i].n++;}}}
let tsumx=0,tsumx2=0,tn=0;for(let i=0,tl=partials.length;i<tl;i++){partials[i].ss=partials[i].sumx2-Math.pow(partials[i].sumx,2)/partials[i].n;residual.df+=partials[i].n-1;residual.ss+=partials[i].ss;total.df+=partials[i].n;tsumx+=partials[i].sumx;tsumx2+=partials[i].sumx2;tn+=partials[i].n;}
total.df-=1;total.ss=tsumx2-Math.pow(tsumx,2)/tn;residual.orig_df=residual.df;residual.df-=corrected_df;total.orig_df=total.df;total.df-=corrected_df;replicates=partials[0].n;homogeneityTests();buildTerms();}
function correctForNesting(){if((nfactors==1)||(!nesting))return;let current=0;while(current<terms.length-2){let c=current+1;while(c<terms.length-2){if(terms[current].ss==terms[c].ss){for(let k=0;k<nfactors;k++){if((terms[c].codes[k]!=terms[current].codes[k])){terms[current].codes[k]=2;if(terms[current].order==1){factors[current].nestedin[k]=1;factors[current].type=RANDOM;}}}
terms[current].SS+=terms[c].SS;terms[current].averages=terms[c].averages;terms[current].sumx=terms[c].sumx;terms[current].sumx2=terms[c].sumx2;terms[current].levels=terms[c].levels;terms[current].nlevels=terms[c].nlevels;terms[current].combins=terms[c].combins;terms.splice(c,1);}else{c++;}}
current++;}
correctTermNames();for(let i=0,tl=terms.length-2;i<tl;i++){terms[i].df=1;for(let k=0;k<nfactors;k++){if(terms[i].codes[k]==1)terms[i].df*=factors[k].nlevels-1;if(terms[i].codes[k]==2)terms[i].df*=factors[k].nlevels;}
terms[i].MS=terms[i].SS/terms[i].df;}}
function correctTermNames(){for(let i=0;i<nfactors;i++){for(let j=0;j<nfactors;j++){if(factors[i].nestedin[j]==1){factors[i].depth++;factors[i].nlevels/=factors[j].nlevels;}}}
let nfl=[];for(let i=0;i<nfactors;i++){let nested=factors[i].depth;if(nested>0){let f={};f.index=i;f.codes=factors[i].nestedin;f.depth=factors[i].depth;f.name=factors[i].name;nfl.push(f);}}
nfl.sort(function(a,b){return a.depth-b.depth;});for(let i=0,len=nfl.length;i<len;i++){if(nfl[i].depth>1){for(let j=0,len=nfl.length;j<len;j++){if((i!=j)&&(nfl[j].depth<nfl[i].depth)){for(let k=0;k<nfactors;k++){if((nfl[i].codes[k]==1)&&(nfl[j].codes[k]==1)){let f=nfl[j].index;if(nfl[i].codes[f]==1)nfl[i].codes[k]=0;}}}}
let nm=[];let j=nfl[i].index;for(let k=0;k<nfactors;k++){if(nfl[i].codes[k]==1)nm.push(factors[k].name);}
factors[j].name+='('+nm.join('&times;')+')';}else{let j=nfl[i].codes.indexOf(1);let k=nfl[i].index;if(j!=-1)factors[k].name+='('+factors[j].name+')';}}
for(let i=0,len=terms.length-2;i<len;i++){let nm=[];for(let j=0;j<nfactors;j++){if(terms[i].codes[j]==1){nm.push(factors[j].name);}}
terms[i].name=nm.join('&times;');}}
function displayANOVA(){let text='<div class="ct"><table>'+'<thead><tr><th>Source</th><th>SS</th><th>df</th>'+'<th>MS</th><th>F</th><th>Prob.</th><th>MS Denom.</th>'+'</tr></thead><tbody>';for(let i=0,len=terms.length;i<len;i++){text+='<tr>';text+='<td>'+terms[i].name+'</td>';text+='<td>'+terms[i].SS.toFixed(5).toString()+'</td>';text+='<td>'+terms[i].df.toString()+'</td>';if(terms[i].name!='Total'){text+='<td>'+terms[i].MS.toFixed(5).toString()+'</td>';}else{text+='<td></td>';}
let nm=terms[i].against;if((i<(terms.length-2))&&(nm!=-1)){text+='<td>'+terms[i].F.toFixed(5).toString()+'</td>';let prob='';if(terms[i].P>rejection_level)prob=terms[i].P.toFixed(5).toString();else prob='<b><i>'+terms[i].P.toFixed(5).toString()+'</i></b>';text+='<td>'+prob+'</td>';text+='<td>'+terms[nm].name+'</td>';}else{text+='<td></td>';text+='<td></td>';if(nm==-1)text+='<td><b>No Test</b></td>';else text+='<td></td>';}
text+='</tr>';}
text+='</tbody></table></div>';let d=document.getElementById('analysis');d.innerHTML=text;}
function displayAverages(){let d=document.getElementById('averages');let table='';for(let i=0,len=terms.length-2;i<len;i++){table+='<h3>Averages for '+terms[i].name+'</h3>';table+='<table><thead><tr>';let cds=[...terms[i].codes];for(let j=0,jlen=cds.length;j<jlen;j++){if(cds[j]!=1)cds[j]='-';else table+='<th>'+factors[j].name+'</th>';}
table+='<th>Average</th><th>n</th><th>St. Dev.</th>'+'<th>Variance</th></tr></thead><tbody>';for(let j=0,jlen=terms[i].average.length;j<jlen;j++){table+='<tr>';let levs=terms[i].levels[j].split(',');for(let k=0,klen=levs.length;k<klen;k++){if(cds[k]==1){table+='<td>'+factors[k].levels[levs[k]]+'</td>';}}
table+='<td>'+terms[i].average[j].toString()+'</td>';let n=parseInt(terms[i].n[j]);table+='<td>'+n.toString()+'</td>';let std=0,variance=0;if(n>1){variance=(terms[i].sumx2[j]-Math.pow(terms[i].sumx[j],2)/n);variance=variance/(n-1);std=Math.sqrt(variance,2);}
table+='<td>'+std.toString()+'</td>';table+='<td>'+variance.toString()+'</td>';table+='</tr>';}
table+='</tbody></table>';}
d.innerHTML=table;}
function displayCTRules(){let c=document.getElementById('ctrules');let table='<div class="ct"><table><thead>';table+='<tr><th>Term</th>';table+='<th>Estimates</th></tr></thead><tbody>';for(let i=0,len=terms.length-1;i<len;i++){table+='<tr><td>'+terms[i].name+'</td>';let components=[],name='',vc='&sigma',compname='',maincomp='';for(let j=terms.length-2;j>=0;j--){if(terms[i].varcomp[j]>0){if((terms[j].name==='Error')||(terms[j].name==='Residual'))name='&epsilon;';else name=terms[j].name;if(terms[j].type===RANDOM)vc='&sigma;';else vc='&Sigma;';if(terms[i].varcomp[j]===1)compname=vc+'<sup>2</sup><sub>'+name+'</sub>';else compname=terms[i].varcomp[j].toString()+'&middot;'+vc+'<sup>2</sup><sub>'+name+'</sub>';if(i!=j)components.push(compname);else maincomp='<span class="ctcomp">'+compname+'</span>';}}
components.push(maincomp);table+='<td>'+components.join(' + ')+'</td></tr>';}
table+='</tbody></table></div>';c.innerHTML=table;}
function displayData(){let tb=document.getElementById('datatab');let table='<div class="ct" id="datatable"></div>';table+='<div class="ct">'+'<h3>Transformations</h3>'+'<p><input type="radio" name="transf" value="none"'+' onclick="anova.transformData(0)" checked>None</p>'+'<p><input type="radio" name="transf" value="sqrt"'+' onclick="anova.transformData(1)">&radic;X</p>'+'<p><input type="radio" name="transf" value="sqrt3"'+' onclick="anova.transformData(2)">&#8731;X</p>'+'<p><input type="radio" name="transf" value="sqrt4"'+' onclick="anova.transformData(3)">&#8732;X</p>'+'<p><input type="radio" name="transf" value="log"'+' onclick="anova.transformData(4)">Log(X+1)</p>'+'<p><input type="radio" name="transf" value="ln"'+' onclick="anova.transformData(5)">Ln(X+1)</p>'+'<p><input type="radio" name="transf" value="arcsin"'+' onclick="anova.transformData(6)">arcsin(X)</p>'+'<p><input type="radio" name="transf" value="mult"'+' onclick="anova.transformData(7)">X &times;'+' <input type="number" id="multc" value="100"></p>'+'<p><input type="radio" name="transf" value="div"'+' onclick="anova.transformData(8)">X &divide;'+' <input type="number"  id="divc" value="100"></p>'+'<p><input type="radio" name="transf" value="pow"'+' onclick="anova.transformData(9)">X&#8319;'+' <input type="number"  id="powc" value="0.25"></p>'+'</div>';tb.innerHTML=table;displayDataTable();}
function displayDataTable(){let tb=document.getElementById('datatable');let table='<table><thead><tr>';for(let i=0,nf=factors.length;i<nf;i++){table+='<th>'+factors[i].name+'</th>';}
table+='<th>DATA</th></tr></thead><tbody>';for(let i=0,len=data.length;i<len;i++){table+='<tr>';for(let j=0,nf=factors.length;j<nf;j++){table+='<td>'+data[i].levels[j]+'</td>';}
table+='<td>'+data[i].value.toString()+'</td></tr>';}
table+='</tbody></table>';tb.innerHTML=table;}
function displayMultipleComparisons(){let d=document.getElementById('mtests');let text='<div class="ct">'+'<h3>Multiple Comparison Tests</h3>'+'<p><input type="radio" name="test" value="none" checked>None</p>'+'<p><input type="radio" name="test" value="snk">Student-Newman-Keuls (SNK)</p>'+'<p><input type="radio" name="test" value="tukey">Tukey (HSD)</p>'+'<p>Rejection criteria (&alpha;): <input type="number" id="mtests_alpha" value="'+
mt_rejection_level.toString()+'" min="0.00000" max="0.999999" step="0.01" onchange="anova.setMtAlpha()"/></p>'+'<p><button onclick="anova.multipleTests()">Compute</button></p>'+'</div>'+'<div class="ct" id="mtest_results" style="display: none;"></div>';d.innerHTML=text;}
function getPartialSS(){let tl=terms.length,pl=partials.length;for(let i=0;i<tl;i++){let c=terms[i].codes;let nm=[];for(let j=0,l=c.length;j<l;j++){if(c[j]==1)nm.push(factors[j].name);}
terms[i].name=nm.join('&times;');for(let j=0;j<pl;j++){let t=[];for(let k=0;k<nfactors;k++){if(c[k]===1)t.push(partials[j].codes[k]);else t.push('-');}
let idx=terms[i].levels.indexOf(t.toString());if(idx!=-1){terms[i].sumx[idx]+=partials[j].sumx;terms[i].sumx2[idx]+=partials[j].sumx2;terms[i].n[idx]+=partials[j].n;}else{terms[i].levels.push(t.toString());terms[i].sumx.push(partials[j].sumx);terms[i].sumx2.push(partials[j].sumx2);terms[i].n.push(partials[j].n);terms[i].nlevels++;}}
if(terms[i].nlevels!=terms[i].combins)nesting=true;if(nesting)residual.name='Residual';for(let j=0,nl=(terms[i].n.length-1);j<nl;j++){if(terms[i].n[j]!=terms[i].n[j+1]){alert('Asymmetrical data set. Analysis stopped!');return false;}}
let v;for(let j=0,nl=terms[i].nlevels;j<nl;j++){terms[i].average[j]=terms[i].sumx[j]/terms[i].n[j];v=terms[i].sumx2[j]-Math.pow(terms[i].sumx[j],2)/terms[i].n[j];terms[i].ss+=v;}
if(terms[i].order==1){terms[i].SS=total.ss-terms[i].ss;}else{let tSS=total.ss;for(let j=0;j<i;j++){let cj=terms[j].codes,cjl=c.length;let included=true;for(let k=0;k<cjl;k++)
if((cj[k]==1)&&(c[k]==0))included=false;if(included)tSS-=terms[j].SS;}
terms[i].SS=tSS-terms[i].ss;}}
let te={idx:tl,name:residual.name,codes:new Array(nfactors+1).fill(1),order:terms[tl-1].order+1,combins:0,nlevels:0,levels:[],sumx:[],sumx2:[],n:[],average:[],ss:0,df:residual.df,SS:residual.ss,ct_codes:new Array(nfactors+1).fill(1),varcomp:[],MS:0,P:0,against:-2,F:0,type:RANDOM};terms.push(te);let tt={idx:tl+1,name:'Total',codes:new Array(nfactors+1).fill(1),order:terms[tl].order+1,combins:0,nlevels:0,levels:[],sumx:[],sumx2:[],n:[],average:[],ss:0,df:total.df,SS:total.ss,ct_codes:[],varcomp:[],MS:0,P:0,against:-2,F:0,type:RANDOM};terms.push(tt);return true;}
function homogeneityTests(){let d=document.getElementById('homogen');d.innerHTML='<div class="ct"><h2>Cochran\'s test</h2>'+
testCochran()+'</div>';d.innerHTML+='<div class="ct"><h2>Bartlett\'s test</h2>'+
testBartlett()+'</div>';}
function testBartlett(){let k=partials.length;let N=0;for(let i=0;i<partials.length;i++)N+=partials[i].n;let pvar=0,v;for(let i=0;i<partials.length;i++){v=(partials[i].sumx2-Math.pow(partials[i].sumx,2)/partials[i].n);v=v/(N-k);pvar+=v;}
let A=(N-k)*Math.log(pvar);let B=0,si2;for(let i=0;i<partials.length;i++){si2=(partials[i].sumx2-Math.pow(partials[i].sumx,2)/partials[i].n);si2=si2/(partials[i].n-1);B+=(partials[i].n-1)*Math.log(si2);}
let C=1/(3*(k-1));let D=0;for(let i=0;i<partials.length;i++){D+=(1/(partials[i].n-1)-1/(N-k));}
let bartlett_k=(A-B)/(1+(C*D));let prob=1.0-jStat.chisquare.cdf(bartlett_k,k-1);if(prob>1)prob=1;if(prob<0)prob=0;let result='';result+='<p>Bartlett\'s Test for <b><i>k</i> = '+k.toString()+'</b> averages and <b>&nu; = '+(k-1).toString()+'</b> degrees of freedom: <b>'+bartlett_k.toString()+'</b></p><p>P = <b>'+prob.toString()+'</b></p>';return result;}
function testCochran(){let maxvar=0;let sumvar=0;let k=partials.length;let df=replicates-1;for(let i=0;i<k;i++){let v=partials[i].sumx2-Math.pow(partials[i].sumx,2)/partials[i].n;v=v/(partials[i].n-1);if(v>maxvar)maxvar=v;sumvar+=v;}
let cochran_C=maxvar/sumvar;let prob=0.0;if((cochran_C>0)&&(k>1)){prob=jStat.centralF.cdf((1/cochran_C-1)/(k-1),((k-1)*df),df)*k;if(prob>1)prob=Math.abs(Math.floor(prob)-prob);}
let result='';result+='<p>Cochran\'s Test for <b><i>k</i> = '+
k.toString()+'</b> averages and <b>&nu; = ';result+=df.toString()+'</b> degrees of freedom: <b>'+
cochran_C.toString()+'</b></p>';result+='<p>P = <b>'+prob.toString()+'</b></p>';let cv10=0;let cv05=0;let cv01=0;cv10=1/(1+(k-1)/(jStat.centralF.inv(1-0.10/k,df,df*(k-1))));cv05=1/(1+(k-1)/(jStat.centralF.inv(1-0.05/k,df,df*(k-1))));cv01=1/(1+(k-1)/(jStat.centralF.inv(1-0.01/k,df,df*(k-1))));result+="<p>Critical values for &alpha;</p>";result+="<p><i>0.10</i>: "+cv10.toString()+", hence variances are ";result+=(cochran_C>cv10?"heterogeneous":"homogeneous");result+="</p>";result+="<p><i>0.05</i>: "+cv05.toString()+", hence variances are ";result+=(cochran_C>cv05?"heterogeneous":"homogeneous");result+="</p>";result+="<p><i>0.01</i>: "+cv01.toString()+", hence variances are ";result+=(cochran_C>cv01?"heterogeneous":"homogeneous");result+="</p>";return result;}
function studentizedComparisons(test,fact,df,ms,avgs){let t="";let comps=[],p=0;let total_range=avgs.length;let range=total_range;do{let times=total_range-range+1;for(let i=0;i<times;i++){let j=i+range-1;let q=Math.abs(avgs[i].average-avgs[j].average)/Math.sqrt(ms/avgs[i].n);if(test=='tukey')p=1-jStat.tukey.cdf(q,total_range,df);if(test=='snk')p=1-jStat.tukey.cdf(q,range,df);if(p>mt_rejection_level){let included=false;for(let k=0,kl=comps.length;k<kl;k++){if((i>=comps[k][0])&&(j<=comps[k][1])){included=true;break;}}
if(!included){comps.push([i,j]);}}}
range--;}while(range>1);for(let i=0,il=avgs.length;i<il;i++){let included=false;for(let j=0,jl=comps.length;j<jl;j++){if((i>=comps[j][0])&&(i<=comps[j][1])){included=true;break;}}
if(!included){comps.push([i,i]);}}
comps.sort((a,b)=>(a[0]>b[0])?1:-1);t+='<table>';t+='<tr><th>Level</th><th>Average</th><th>n</th>';for(let i=0,il=comps.length;i<il;i++)t+='<th>&nbsp;</th>';t+='</tr>';for(let i=0,il=avgs.length;i<il;i++){t+='<tr><td>'+avgs[i].level+'</td><td>'+avgs[i].average.toString()+'</td><td>'+avgs[i].n.toString()+'</td>';for(let j=0,jl=comps.length;j<jl;j++){if((i>=comps[j][0])&&(i<=comps[j][1]))t+='<td>&#9679;</td>';else t+='<td>&nbsp;</td>';}
t+='</tr>';}
t+='</table>';return t;}
function multipleTests(){let studentized=['snk','tukey','duncan'];let elem=document.getElementsByName("test");let testName=0;for(let i=0;i<elem.length;i++){if(elem[i].checked){testName=elem[i].value;break;}}
elem=document.getElementById("mtest_results");if(testName!='none'){let text="";for(let i=0,len=mcomps.length;i<len;i++){let dferr=mcomps[i].df_against,mserr=mcomps[i].ms_against,fcode=mcomps[i].fcode;text+='<h3>Multiple comparisons for levels of factor '+mcomps[i].fname;if(mcomps[i].type=='interaction')text+=' within levels of '+mcomps[i].term+'</h3>';else text+='</h3>';for(let a in mcomps[i].averages){if(mcomps[i].type=='interaction'){let f=a.split(',');let t=[];for(let j=0,jlen=f.length;j<jlen;j++){if(f[j]!='-'){t.push('level <i>'+factors[j].levels[f[j]]+'</i> of factor '+factors[j].name);}}
text+='<h4>For '+t.join(' and ')+'</h4>';}
if(studentized.indexOf(testName)!=-1){text+=studentizedComparisons(testName,fcode,dferr,mserr,mcomps[i].averages[a]);}}}
if(text=="")text="<h3>No multiple tests available!</h3>Are you sure there are significant differences in fixed factors?";elem.innerHTML=text;elem.style.display='inline-block';}else{elem.innerHTML="";elem.style.display='none';}}
function openDataFile(){let selectedFile=document.getElementById('loadFile').files[0];if(typeof(selectedFile)==='undefined')return;let textType=/text.*/;if(selectedFile.type.match(textType)){filename=selectedFile.name;let h=document.getElementById('filename');h.innerHTML='Current selected file is <b>'+filename+'</b>';resetAnalysis();let reader=new FileReader();reader.onload=function(e){let header=true;let text=reader.result;let lines=text.split('\n');for(let i=0,len=lines.length;i<len;i++){let li=lines[i].trim();if((li[0]!=='#')&&(li.length!==0)){li=li.split(/[\s\t]+/);if(header){nfactors=li.length-1;for(let j=0,k=li.length-1;j<k;j++){factors[j]={};let name=li[j];if(name.endsWith("*")){factors[j].type=RANDOM;name=name.slice(0,name.length-1);}else{factors[j].type=FIXED;}
factors[j].name=name;factors[j].orig_name=name;factors[j].nlevels=0;factors[j].levels=[];factors[j].nestedin=new Array(nfactors).fill(0);factors[j].depth=0;factors[j].subscript=String.fromCharCode(j+105);}
header=false;}else{if(li.length!=nfactors+1){let ln=i+1;let c=li.length.toString();let e=nfactors+1;alert('In line '+ln.toString()+' number of columns ('+
c+') is different from what is expected ('+
e.toString()+')');return;}
let d={};d.levels=[];for(let j=0;j<nfactors;j++){let p=factors[j].levels.indexOf(li[j]);if(p==-1){factors[j].levels.push(li[j]);factors[j].nlevels++;}
d.levels.push(li[j]);}
let n=+li[nfactors].replace(",",".");let a=Number.parseFloat(n);if(Number.isNaN(a)){let ln=i+1;alert('In line '+ln.toString()+' data value ('+
n.toString()+') is not a valid number!');return;}else{d.value=n;d.original=n;if(n>max_value)max_value=n;if(n<min_value)min_value=n;}
data.push(d);}}}
let elem=document.getElementsByClassName("tabcontent");for(let i=0,len=elem.length;i<len;i++){elem[i].innerHTML="";}
displayData();computePartials();selectTab('analysis');}
reader.readAsText(selectedFile);document.getElementById('loadFile').value="";}else{alert('File type of '+filename+' not supported by your browser.');}}
function settings(){let elem=document.getElementById("anovadisplay");let sets=document.getElementById("settings");if(elem.style.display=="none"){elem.style.display="block";sets.style.display="none";}else{elem.style.display="none";sets.style.display="block";}}
function transformData(t){let multc=parseFloat(document.getElementById("multc").value);let divc=parseFloat(document.getElementById("divc").value);let powc=parseFloat(document.getElementById("powc").value);max_value=Number.MIN_SAFE_INTEGER;min_value=Number.MAX_SAFE_INTEGER;switch(t){case 0:resetData();break;case 1:if(min_value>=0)data.forEach(e=>e.value=Math.sqrt(e.value));else alert("Cannot apply transformation to negative values!");break;case 2:if(min_value>=0)data.forEach(e=>e.value=Math.pow(e.value,1/3));else alert("Cannot apply transformation to negative values!");break;case 3:if(min_value>=0)data.forEach(e=>e.value=Math.pow(e.value,1/4));else alert("Cannot apply transformation to negative values!");break;case 4:if(min_value>0)data.forEach(e=>e.value=Math.log(e.value+1)/Math.log(10));else alert("Cannot apply transformation to negative or null values!");break;case 5:if(min_value>0)data.forEach(e=>e.value=Math.log(e.value+1));else alert("Cannot apply transformation to negative or null values!");break;case 6:if((min_value>=0)&&(max_value<=1))data.forEach(e=>e.value=Math.asin(e.value));else alert("Cannot apply transformation to values larger than 1 or smaller than 0!");break;case 7:data.forEach(e=>e.value*=multc);break;case 8:if(divc!=0)data.forEach(e=>e.value/=divc);else alert("Cannot divide by zero!");break;case 9:data.forEach(e=>Math.pow(e.value,powc));break;}
cleanVariables();computePartials();displayDataTable();}
function setAlpha(){rejection_level=parseFloat(document.getElementById('anova_alpha').value);if(rejection_level>1)rejection_level=0.9999999;if(rejection_level<0)rejection_level=0.0000001;displayANOVA();}
function setMtAlpha(){let mta=document.getElementById('mtests_alpha').value;if(mta!=null){mt_rejection_level=parseFloat(mta);if(mt_rejection_level!=NaN){if(rejection_level>1)rejection_level=0.9999999;if(rejection_level<0)rejection_level=0.0000001;console.log(mt_rejection_level)
buildMultipleComparisons();multipleTests();}else{mt_rejection_level=DDEFAULT_REJECTION_LEVEL;}}}
function ignoreInteractions(){let h=document.getElementById("ignore_interactions");if(ignoreinteractions===false)ignoreinteractions=true;else ignoreinteractions=false;}
function resetData(){let h=document.getElementsByClassName("tabcontent");for(let i=0,len=h.length;i<len;i++)h[i].innerHTML="";max_value=Number.MIN_SAFE_INTEGER;min_value=Number.MAX_SAFE_INTEGER;for(let i=0;i<data.length;i++){data[i].value=data[i].original;if(data[i].value>max_value)max_value=data[i].value;if(data[i].value<min_value)min_value=data[i].value;}
cleanVariables();computePartials();displayData();}
function resetAnalysis(){let s=document.getElementsByClassName('tabcontent')
for(let i=0,len=s.length;i<len;i++){if(typeof(s[i])!=='undefined'&&s[i]!==null)s[i].innerHTML='';}
nfactors=0;factors=[];data=[];partials=[];terms=[];mcomps=[];corrected_df=0;replicates=0;total={df:0,ss:0};residual={name:'Error',df:0,ss:0};nesting=false;max_value=Number.MIN_SAFE_INTEGER;min_value=Number.MAX_SAFE_INTEGER;}
function cleanVariables(){for(let i=0;i<factors.length;i++){factors[i].name=factors[i].orig_name;factors[i].nlevels=factors[i].levels.length;factors[i].nestedin=new Array(nfactors).fill(0);factors[i].depth=0;}
partials=[];terms=[];mcomps=[];corrected_df=0;replicates=0;total={df:0,ss:0};residual={name:"Error",df:0,ss:0};nesting=false;}
return{setAlpha:setAlpha,setMtAlpha:setMtAlpha,openDataFile:openDataFile,resetData:resetData,transformData:transformData,multipleTests:multipleTests,settings:settings,ignoreInteractions:ignoreInteractions}})();function selectTab(name){let tabs=document.getElementsByClassName('tabs');for(let i=0,len=tabs.length;i<len;i++){if(tabs[i].name==name)tabs[i].classList.add('selected');else tabs[i].classList.remove('selected');}
let tabcontent=document.getElementsByClassName('tabcontent');for(let i=0,len=tabcontent.length;i<len;i++){if(tabcontent[i].id==name)tabcontent[i].style.display='block';else tabcontent[i].style.display='none';}}
document.addEventListener('DOMContentLoaded',function(){let b=document.getElementsByClassName('tabcontent');for(let i=0;i<b.length;i++)b[i].style.display='none';let s=document.getElementById('settings');s.style.display='none';document.getElementById('openFile').onclick=function(){document.getElementById('loadFile').click()};document.getElementById('loadFile').onchange=function(){anova.openDataFile();};document.getElementById('activate_settings').onclick=function(){anova.settings();};});